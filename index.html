<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>éŸ©å›½è¿åŠ¨åå¥½ Ã— ä¸ªæ€§åŒ–é©¬æ‹‰æ¾å°åŠ©æ‰‹ï¼ˆå«å°æ¸¸æˆï¼‰</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f7f9fc; --card:#ffffff; --text:#0f1724; --muted:#6b7280;
      --accent1:#7B61FF; --accent2:#5AA0FF; --accent3:#ff7a6b;
      --game-bg:#0b1220; --game-panel:#0f1724;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Arial; margin:0; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased}
    .header{display:flex;justify-content:space-between;align-items:center;padding:24px 36px}
    .brand{display:flex;gap:14px;align-items:center}
    .logo{width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,var(--accent1),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-weight:800}
    .h-title{font-size:18px;font-weight:800}
    .h-sub{font-size:13px;color:var(--muted)}
    .langs{display:flex;gap:8px}
    .langs button{background:transparent;border:1px solid rgba(15,23,36,0.06);padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
    .langs button.active{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white;border:0}

    .container{max-width:1100px;margin:12px auto;padding:0 20px}
    .grid{display:grid;grid-template-columns:1fr 380px;gap:20px}
    .card{background:var(--card);border-radius:16px;padding:18px;box-shadow:0 12px 36px rgba(19,59,102,0.04);border:1px solid rgba(16,24,40,0.03)}
    .section-title{font-size:16px;font-weight:700;margin-bottom:8px}
    .lead{color:var(--muted);font-size:13px;margin-bottom:12px}
    .canvas-wrap{border-radius:12px;padding:12px;background:linear-gradient(180deg,#fbfdff,#f2f7ff)}
    .legend{display:flex;flex-direction:column;gap:8px;margin-top:10px}
    .legend-item{display:flex;gap:12px;align-items:flex-start}
    .swatch{width:12px;height:12px;border-radius:4px}

    .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #e6eefc;background:transparent}
    .btn{padding:10px 14px;border-radius:12px;border:0;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;font-weight:700;cursor:pointer}
    .btn.secondary{background:linear-gradient(135deg,#ff8a7a,#ff5a5f)}
    .btn.ghost{background:transparent;border:1px solid rgba(16,24,40,0.06);color:var(--text)}
    .result{margin-top:12px;background:linear-gradient(180deg,#f8fbff,#fff);padding:12px;border-radius:12px;border:1px solid #eef6ff;display:none}
    .result.show{display:block}
    .stat-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .stat{background:#fff;padding:12px;border-radius:10px;box-shadow:0 6px 14px rgba(2,6,23,0.03)}
    .stat-label{font-size:12px;color:var(--muted)}
    .stat-value{font-size:18px;font-weight:800;color:var(--accent1)}

    .route{margin-top:14px}
    #routeBox{height:84px;border-radius:12px;background:linear-gradient(90deg,#eef6ff,#f7fbff);position:relative;overflow:hidden;border:1px solid #e6f0ff}
    .runner-svg{width:48px;height:48px;position:absolute;top:18px;left:12px;transition:left 3s linear, transform 0.2s linear}
    .runner-svg.running{animation:bob 0.45s steps(2,end) infinite}
    @keyframes bob{0%{transform:translateY(0)}50%{transform:translateY(-4px)}100%{transform:translateY(0)}}

    /* æ¸¸æˆå¡ï¼ˆæš—è‰²é£ï¼‰ */
    .game-card{margin-top:14px;border-radius:12px;overflow:hidden;border:1px solid rgba(2,6,23,0.06)}
    .game-header{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;background:linear-gradient(90deg,#071025,#0b1320);color:#e8f7ff}
    .game-body{display:flex;gap:18px;padding:16px;background:linear-gradient(180deg,#071024,#071228)}
    .game-canvas-wrap{flex:1;border-radius:10px;overflow:hidden;background:linear-gradient(180deg,#0b1220,#071025);padding:10px;position:relative}
    #gameCanvas{width:100%;height:360px;display:block;border-radius:8px;background:linear-gradient(180deg,#071025,#081326)}
    .game-controls{width:320px;min-width:220px;color:#cfeeff}
    .hud-row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
    .chip{background:rgba(255,255,255,0.03);padding:8px;border-radius:8px;font-weight:700;color:var(--muted)}
    .chip .val{display:block;color:#bff0ff;font-weight:900}
    .control-btn{display:flex;gap:8px;margin-top:10px}
    .control-btn button{flex:1;padding:10px;border-radius:10px;border:0;background:linear-gradient(135deg,#00a6d9,#00d4ff);color:#041425;font-weight:800;cursor:pointer}
    .control-btn .ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:#bfefff}
    .small-note{font-size:12px;color:#a9cfe0;margin-top:8px}

    footer{padding:18px;color:var(--muted);text-align:center}

    @media(max-width:980px){.grid{grid-template-columns:1fr}.game-body{flex-direction:column}.game-controls{width:100%}}
  </style>
</head>
<body>
  <div class="header">
    <div class="brand">
      <div class="logo">KR</div>
      <div>
        <div class="h-title" id="headerTitle">í•œêµ­ ìš´ë™åå¥½ Ã— ä¸ªæ€§åŒ– ë§ˆë¼æ¾ ì–´ì‹œìŠ¤í„´íŠ¸</div>
        <div class="h-sub">éŸ©å›½è¿åŠ¨åå¥½ Ã— ä¸ªæ€§åŒ–é©¬æ‹‰æ¾å°åŠ©æ‰‹</div>
      </div>
    </div>
    <div class="langs">
      <button id="btnKR">KR</button>
      <button id="btnCN">CN</button>
    </div>
  </div>

  <div class="container">
    <div class="grid">
      <!-- LEFT ä¸»å†…å®¹ -->
      <div>
        <section class="card">
          <div class="section-title" id="title1">â‘  éŸ©å›½äººæœ€å¸¸å‚ä¸çš„è¿åŠ¨ï¼ˆäº’åŠ¨ï¼‰</div>
          <div class="lead" id="lead1">å°†é¼ æ ‡ç§»åˆ°æŸä¸ªè¿åŠ¨ â†’ æ˜¾ç¤ºç®€ä»‹ï¼›ç‚¹å‡»â€œè·‘æ­¥/é©¬æ‹‰æ¾â€å°†è·³è½¬åˆ°é©¬æ‹‰æ¾å°åŠ©æ‰‹å¹¶å±•å¼€å°æ¸¸æˆã€‚</div>
          <div class="canvas-wrap">
            <canvas id="sportChart" height="220"></canvas>
          </div>
          <div class="legend" id="legend"></div>
        </section>

        <section class="card" style="margin-top:16px">
          <div class="section-title" id="title2">â‘¡ éŸ©å›½é©¬æ‹‰æ¾å‚ä¸è¶‹åŠ¿</div>
          <div class="lead" id="lead2">ç¤ºä¾‹æ•°æ®ï¼šç”¨äºå±•ç¤ºäº¤äº’ä¸è¶‹åŠ¿ï¼ˆä¸‡ äººï¼‰</div>
          <div class="canvas-wrap" style="padding:8px;margin-top:8px">
            <canvas id="trendChart" height="140"></canvas>
          </div>
          <div style="margin-top:10px;color:var(--muted)" id="trendNote">ç¤ºä¾‹ç»“è®ºï¼šåŠé©¬ &gt; å…¨é©¬ &gt; 10Kï¼›è¿‘å¹´å‚ä¸äººæ•°ä¸Šå‡</div>
        </section>
      </div>

      <!-- RIGHT ä¾§è¾¹ï¼šå°åŠ©æ‰‹ + æ¨¡æ‹Ÿ + æ¸¸æˆå…¥å£ -->
      <aside class="card">
        <div class="section-title" id="assistantTitle">â‘¢ ä¸ªäººé©¬æ‹‰æ¾é€‚é…åˆ†æ</div>
        <div class="lead" id="assistantLead">è¾“å…¥ï¼šå¹´é¾„ / æ€§åˆ«(é€‰å¡«) / èº«é«˜ / ä½“é‡ / è¿åŠ¨é¢‘ç‡ / ç›®æ ‡èµ›äº‹ â†’ æ¨è & é¢„è®¡æ—¶é—´</div>

        <div style="margin-top:12px">
          <div class="form-grid">
            <div>
              <label id="lblAge">å¹´é¾„</label>
              <input id="age" type="number" placeholder="e.g. 28" />
            </div>
            <div>
              <label id="lblGender">æ€§åˆ«ï¼ˆì„ íƒï¼‰</label>
              <select id="gender">
                <option value="">ä¸å¡«å†™</option>
                <option value="male">ç”· / ë‚¨</option>
                <option value="female">å¥³ / ì—¬</option>
              </select>
            </div>
            <div>
              <label id="lblHeight">èº«é«˜ï¼ˆcmï¼‰</label>
              <input id="height" type="number" placeholder="e.g. 170" />
            </div>
            <div>
              <label id="lblWeight">ä½“é‡ï¼ˆkgï¼‰</label>
              <input id="weight" type="number" placeholder="e.g. 65" />
            </div>
            <div class="full">
              <label id="lblFreq">å¹³æ—¶è¿åŠ¨é‡</label>
              <select id="freq">
                <option value="low">å¾ˆå°‘</option>
                <option value="1">ä¸€å‘¨ 1â€“2 æ¬¡</option>
                <option value="2">ä¸€å‘¨ 3â€“4 æ¬¡</option>
                <option value="3">æ¯å‘¨è¶…è¿‡ 5 æ¬¡</option>
              </select>
            </div>
            <div class="full">
              <label id="lblGoal">ç›®æ ‡èµ›äº‹</label>
              <select id="goal">
                <option value="10">10 å…¬é‡Œ</option>
                <option value="21">åŠç¨‹é©¬æ‹‰æ¾ (21km)</option>
                <option value="42">å…¨ç¨‹é©¬æ‹‰æ¾ (42km)</option>
              </select>
            </div>
          </div>

          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn" id="runAnalyze">å¼€å§‹åˆ†æ</button>
            <button class="btn secondary" id="quickEstimate">å¿«é€Ÿä¼°ç®—æ—¶é—´</button>
            <button class="btn ghost" id="clearBtn">é‡ç½®</button>
          </div>

          <div class="result" id="resultBox" aria-live="polite"></div>

          <div class="route" style="margin-top:12px">
            <div class="section-title" id="simTitle">â‘£ è·¯çº¿æ¨¡æ‹Ÿå™¨</div>
            <div id="routeBox" style="margin-top:8px">
              <svg id="miniRunner" class="runner-svg" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <g fill="none" stroke="#ff5a5f" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <circle cx="14" cy="10" r="4" fill="#ff5a5f" />
                  <path d="M18 14c6 2 12 6 16 10" />
                  <path d="M24 22c4 6 8 12 10 18" />
                  <path d="M10 34c6-2 8-8 14-8" />
                  <path d="M28 44l8-6 8 2" />
                </g>
              </svg>
            </div>
            <div style="display:flex;gap:8px;margin-top:10px;align-items:center">
              <button class="btn" id="startRun">å¼€å§‹æ¨¡æ‹Ÿ / ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘</button>
              <button class="btn ghost" id="openGameBtn" title="æ‰“å¼€å°æ¸¸æˆï¼ˆåœ¨é¡µé¢å†…ï¼‰">Play Mini-Game</button>
              <div style="align-self:center;color:var(--muted);font-size:13px" id="routeHint">ç‚¹å‡»å¼€å§‹ï¼Œè·‘æ­¥å°äººä¼šæ²¿è·¯çº¿å‰è¿›</div>
            </div>
          </div>

          <!-- è¿™é‡Œæ”¾æ¸¸æˆå¡ï¼ˆé»˜è®¤æŠ˜å ï¼‰ -->
          <div id="gameCard" class="game-card" style="display:none;margin-top:14px">
            <div class="game-header">
              <div style="font-weight:800">ğŸ Futuristic Marathon Mini-Game</div>
              <div style="font-size:12px;color:#cfefff">é”®ç›˜ï¼šâ† â†’ / Shift å†²åˆº / Space è·³</div>
            </div>
            <div class="game-body">
              <div class="game-canvas-wrap">
                <canvas id="gameCanvas" width="800" height="360" tabindex="0"></canvas>
              </div>
              <div class="game-controls">
                <div class="hud-row">
                  <div class="chip">Distance <span class="val" id="hudDist">0.00 km</span></div>
                </div>
                <div class="hud-row">
                  <div class="chip">Pace <span class="val" id="hudPace">--'--"</span></div>
                </div>
                <div class="hud-row">
                  <div class="chip">Energy <span class="val" id="hudEnergy">100%</span></div>
                </div>

                <div style="margin-top:12px" class="small-note">ç§»åŠ¨ç«¯æŒ‰é’®ï¼š</div>
                <div class="control-btn" style="margin-top:6px">
                  <button id="leftBtn">â—€</button>
                  <button id="sprintBtn">âš¡</button>
                  <button id="rightBtn">â–¶</button>
                </div>
                <div class="small-note">ç›®æ ‡é‡Œç¨‹ä¼šæ˜¾ç¤º 5 / 10 / 21 km è·¯ç‰Œæç¤ºã€‚</div>
              </div>
            </div>
          </div>

        </div>
      </aside>
    </div>

    <footer>ç¤ºä¾‹ç½‘é¡µ Â· ç»“åˆï¼šéŸ©å›½è¿åŠ¨åå¥½ Ã— ä¸ªæ€§åŒ–é©¬æ‹‰æ¾å°åŠ©æ‰‹ï¼ˆå«å°æ¸¸æˆï¼‰</footer>
  </div>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

  <script>
  /* ===========================
     è¯­è¨€/å›¾è¡¨/åˆ†æï¼ˆä¸ä½ åŸç½‘é¡µä¸€è‡´ï¼‰
     =========================== */
  const LANG = {
    kr: { headerTitle:'í•œêµ­ ìš´ë™ íŠ¸ë Œë“œ Ã— ë§ˆë¼í†¤ í¼ìŠ¤ë„ ì–´ì‹œìŠ¤í„´íŠ¸', title1:'â‘  í•œêµ­ì¸ì´ ì¦ê¸°ëŠ” ìš´ë™ (ì¸í„°ë™í‹°ë¸Œ)', lead1:'ì°¨íŠ¸ì—ì„œ í•­ëª©ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ì„¤ëª…ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤. "ë‹¬ë¦¬ê¸°/ë§ˆë¼í†¤" í´ë¦­ ì‹œ ì–´ì‹œí„´íŠ¸ë¡œ ì´ë™í•©ë‹ˆë‹¤.', title2:'â‘¡ í•œêµ­ ë§ˆë¼í†¤ ì°¸ê°€ ì¶”ì´ (ì˜ˆì‹œ ë°ì´í„°)', lead2:'ì˜ˆì‹œ ë°ì´í„°ëŠ” ë°ëª¨ìš©ì…ë‹ˆë‹¤: ë§ˆë¼í†¤ ì°¸ê°€ì ìˆ˜(ë§Œ ëª…) ì¶”ì´ì…ë‹ˆë‹¤.', trendNote:'ì˜ˆì‹œ ê²°ë¡ : í•˜í”„ > í’€ > 10K; ìµœê·¼ ì°¸ê°€ì ìˆ˜ ì¦ê°€', assistantTitle:'â‘¢ í¼ìŠ¤ë„ ë§ˆë¼í†¤ ì¶”ì²œ', assistantLead:'ì…ë ¥: ë‚˜ì´ / ì„±ë³„(ì„ íƒ) / ì‹ ì¥ / ì²´ì¤‘ / ìš´ë™ ë¹ˆë„ / ëª©í‘œ ì¢…ëª© â†’ ì¶”ì²œ ë° ì˜ˆìƒ ì™„ì£¼ ì‹œê°„', lblAge:'ë‚˜ì´ (ì„¸)', lblGender:'ì„±ë³„ (ì„ íƒ)', lblHeight:'ì‹ ì¥ (cm)', lblWeight:'ì²´ì¤‘ (kg)', lblFreq:'í‰ì†Œ ìš´ë™ëŸ‰', lblGoal:'ëª©í‘œ ì¢…ëª©', runAnalyze:'ë¶„ì„ ì‹œì‘', quickEstimate:'ë¹ ë¥¸ ì‹œê°„ ê³„ì‚°', clearBtn:'ë¦¬ì…‹', resultTitle:'ğŸ“Š ë§ì¶¤ ì¶”ì²œ ê²°ê³¼', bmiLabel:'BMI ì§€ìˆ˜', recommendLabel:'ì¶”ì²œ ì¢…ëª©', paceLabel:'ê¶Œì¥ í˜ì´ìŠ¤', timeLabel:'ì˜ˆìƒ ì™„ì£¼ ì‹œê°„', adviceTitle:'ğŸ“‹ í›ˆë ¨ ê°€ì´ë“œ', noteText:'ğŸ’¡ ì°¸ê³ : ë³¸ ì¶”ì²œì€ BMIì™€ ìê°€ë³´ê³  ìš´ë™ ë¹ˆë„ ê¸°ë°˜ì˜ ì°¸ê³ ìš© ì •ë³´ì…ë‹ˆë‹¤. ì „ë¬¸ ìƒë‹´ ê¶Œì¥ã€‚', alertHeight:'ì‹ ì¥ê³¼ ì²´ì¤‘ì„ ì…ë ¥í•˜ì„¸ìš”', advice10k:['ì£¼ 3íšŒ: ì¥ê±°ë¦¬ 1íšŒ(45-70ë¶„) + ì¸í„°ë²Œ 1íšŒ + íšŒë³µ ëŸ¬ë‹ 1íšŒ','ê·¼ë ¥í›ˆë ¨ ë° ìŠ¤íŠ¸ë ˆì¹­ ë³‘í–‰','ëŒ€íšŒ 6ì£¼ ì „ ì¥ê±°ë¦¬ ì ì§„ ì¦ëŸ‰'], adviceHalf:['10~12ì£¼ í›ˆë ¨ ê¶Œì¥(ì¥ê±°ë¦¬+í…œí¬)','ì£¼ 3-5íšŒ í›ˆë ¨, ì ì§„ì  ê±°ë¦¬ ì¦ê°€','íšŒë³µ ë° ì˜ì–‘ ê´€ë¦¬ ì¤‘ìš”'], adviceFull:['ìµœì†Œ 16ì£¼ ì²´ê³„ì  í›ˆë ¨ ê¶Œì¥','ì£¼ 1íšŒ ì¥ê±°ë¦¬(ì ì§„ 30km+) + í…œí¬/ì¸í„°ë²Œ','ë³´ê¸‰ ì „ëµ ë° ë¶€ìƒ ì˜ˆë°© ì¤‘ìš”'], simStart:'ì‹œë®¬ë ˆì´ì…˜ ì‹œì‘', routeHint:'í´ë¦­í•˜ë©´ ëŸ¬ë‹ ì•„ì´ì½˜ì´ ì´ë™í•©ë‹ˆë‹¤'},
    cn: { headerTitle:'éŸ©å›½è¿åŠ¨åå¥½ Ã— ä¸ªæ€§åŒ–é©¬æ‹‰æ¾å°åŠ©æ‰‹', title1:'â‘  éŸ©å›½äººå¸¸å‚ä¸çš„è¿åŠ¨ï¼ˆäº’åŠ¨å¯è§†åŒ–ï¼‰', lead1:'å°†é¼ æ ‡ç§»åˆ°æŸä¸ªè¿åŠ¨ â†’ æ˜¾ç¤ºç®€ä»‹ï¼›ç‚¹å‡»â€œè·‘æ­¥/é©¬æ‹‰æ¾â€å°†è·³è½¬åˆ°é©¬æ‹‰æ¾å°åŠ©æ‰‹ã€‚', title2:'â‘¡ éŸ©å›½é©¬æ‹‰æ¾å‚ä¸è¶‹åŠ¿ï¼ˆç¤ºä¾‹æ•°æ®ï¼‰', lead2:'ç¤ºä¾‹æ•°æ®ä»…ç”¨äºå±•ç¤ºäº¤äº’ï¼šéŸ©å›½é©¬æ‹‰æ¾å‚ä¸äººæ•°è¶‹åŠ¿ï¼ˆä¸‡ äººï¼‰ã€‚', trendNote:'ç¤ºä¾‹ç»“è®ºï¼šåŠé©¬ > å…¨é©¬ > 10Kï¼›å‚ä¸äººæ•°è¿‘å¹´ä¸Šå‡', assistantTitle:'â‘¢ ä¸ªäººé©¬æ‹‰æ¾é€‚é…åˆ†æ', assistantLead:'è¾“å…¥å¹´é¾„ / æ€§åˆ«ï¼ˆé€‰å¡«ï¼‰ / èº«é«˜ / ä½“é‡ / è¿åŠ¨é¢‘ç‡ / ç›®æ ‡èµ›äº‹ â†’ æ¨èä¸é¢„è®¡å®Œèµ›æ—¶é—´', lblAge:'å¹´é¾„ï¼ˆå²ï¼‰', lblGender:'æ€§åˆ«ï¼ˆé€‰å¡«ï¼‰', lblHeight:'èº«é«˜ï¼ˆcmï¼‰', lblWeight:'ä½“é‡ï¼ˆkgï¼‰', lblFreq:'å¹³æ—¶è¿åŠ¨é‡', lblGoal:'ç›®æ ‡èµ›äº‹', runAnalyze:'å¼€å§‹åˆ†æ', quickEstimate:'å¿«é€Ÿä¼°ç®—æ—¶é—´', clearBtn:'é‡ç½®', resultTitle:'ğŸ“Š ä¸ªæ€§åŒ–æ¨èç»“æœ', bmiLabel:'BMI æŒ‡æ•°', recommendLabel:'æ¨èè·ç¦»', paceLabel:'å»ºè®®é…é€Ÿ', timeLabel:'é¢„è®¡å®Œèµ›æ—¶é—´', adviceTitle:'ğŸ“‹ è®­ç»ƒå»ºè®®', noteText:'ğŸ’¡ æç¤ºï¼šæœ¬æ¨èåŸºäº BMI ä¸è¿åŠ¨é¢‘ç‡ï¼Œä»…ä¾›å‚è€ƒã€‚ä¸“ä¸šè®¡åˆ’è¯·å’¨è¯¢æ•™ç»ƒæˆ–è¿åŠ¨åŒ»å­¦ä¸“å®¶ã€‚', alertHeight:'è¯·è¾“å…¥èº«é«˜å’Œä½“é‡', advice10k:['æ¯å‘¨ 3 æ¬¡è®­ç»ƒï¼šä¸€æ¬¡é•¿è·‘ï¼ˆ45-70 åˆ†é’Ÿï¼‰+ ä¸€æ¬¡é—´æ­‡ + ä¸€æ¬¡è½»æ¾è·‘','åŠ å…¥åŠ›é‡è®­ç»ƒä¸æ‹‰ä¼¸','æ¯”èµ›å‰ 6 å‘¨é€æ­¥å¢åŠ é•¿è·‘è·ç¦»'], adviceHalf:['å»ºè®® 10~12 å‘¨è®­ç»ƒè®¡åˆ’ï¼ŒåŒ…å«é•¿è·‘ä¸èŠ‚å¥è·‘','æ¯å‘¨ 3-5 æ¬¡è®­ç»ƒï¼Œé€æ­¥å¢åŠ é•¿è·ç¦»','é‡è§†æ¢å¤ä¸è¥å…»ï¼Œèµ›å‰ 2 å‘¨å‡é‡è®­ç»ƒ'], adviceFull:['å»ºè®®è‡³å°‘ 16 å‘¨ç³»ç»Ÿè®­ç»ƒå¹¶å’¨è¯¢æ•™ç»ƒ','æ¯å‘¨åŒ…å«é•¿è·‘ï¼ˆé€æ­¥è¾¾åˆ° 30km+ï¼‰ã€èŠ‚å¥è·‘ã€é—´æ­‡è®­ç»ƒ','æ³¨é‡è¡¥ç»™ç­–ç•¥ä¸ä¼¤ç—…é¢„é˜²'], simStart:'å¼€å§‹æ¨¡æ‹Ÿ', routeHint:'ç‚¹å‡»å¼€å§‹ï¼Œè·‘æ­¥å°äººä¼šæ²¿è·¯çº¿å‰è¿›'}
  };

  let lang = 'kr';
  const krBtn = document.getElementById('btnKR');
  const cnBtn = document.getElementById('btnCN');

  function setLang(l){
    if(!LANG[l]) l='kr';
    lang = l; localStorage.setItem('siteLang', l);
    krBtn.classList.toggle('active', l==='kr');
    cnBtn.classList.toggle('active', l==='cn');
    const t = LANG[l];
    document.getElementById('headerTitle').innerText = t.headerTitle;
    document.getElementById('title1').innerText = t.title1;
    document.getElementById('lead1').innerText = t.lead1;
    document.getElementById('title2').innerText = t.title2;
    document.getElementById('lead2').innerText = t.lead2;
    document.getElementById('trendNote').innerText = t.trendNote;
    document.getElementById('assistantTitle').innerText = t.assistantTitle;
    document.getElementById('assistantLead').innerText = t.assistantLead;
    document.getElementById('lblAge').innerText = t.lblAge;
    document.getElementById('lblGender').innerText = t.lblGender;
    document.getElementById('lblHeight').innerText = t.lblHeight;
    document.getElementById('lblWeight').innerText = t.lblWeight;
    document.getElementById('lblFreq').innerText = t.lblFreq;
    document.getElementById('lblGoal').innerText = t.lblGoal;
    document.getElementById('runAnalyze').innerText = t.runAnalyze;
    document.getElementById('quickEstimate').innerText = t.quickEstimate;
    document.getElementById('clearBtn').innerText = t.clearBtn;
    document.getElementById('startRun').innerText = t.simStart || t.simStart;
    document.getElementById('routeHint').innerText = t.routeHint || t.routeHint;

    // dropdown texts
    const genderSelect = document.getElementById('gender');
    if(l==='kr'){ genderSelect.options[0].text='ì„ íƒ ì•ˆ í•¨'; genderSelect.options[1].text='ë‚¨ì„±'; genderSelect.options[2].text='ì—¬ì„±'; }
    else { genderSelect.options[0].text='ä¸å¡«å†™'; genderSelect.options[1].text='ç”·'; genderSelect.options[2].text='å¥³'; }

    const freq = document.getElementById('freq');
    freq.options[0].text = l==='cn' ? 'å¾ˆå°‘' : 'ê±°ì˜ ì•ˆ í•¨';
    freq.options[1].text = l==='cn' ? 'ä¸€å‘¨ 1â€“2 æ¬¡' : 'ì£¼ 1â€“2íšŒ';
    freq.options[2].text = l==='cn' ? 'ä¸€å‘¨ 3â€“4 æ¬¡' : 'ì£¼ 3â€“4íšŒ';
    freq.options[3].text = l==='cn' ? 'æ¯å‘¨è¶…è¿‡ 5 æ¬¡' : 'ì£¼ 5íšŒ ì´ìƒ';

    updateLegend();
  }

  krBtn.addEventListener('click', ()=> setLang('kr'));
  cnBtn.addEventListener('click', ()=> setLang('cn'));
  window.addEventListener('load', ()=> setLang(localStorage.getItem('siteLang') || 'kr'));

  // Charts
  const sportLabels = ['Running / Marathon', 'Football', 'Baseball', 'Gym', 'Badminton', 'Hiking', 'Others'];
  const sportColors = ['#1f6feb','#ff6b6b','#ff9f40','#00c2a8','#7b61ff','#66bb6a','#bfc5cc'];
  const sportData = [35,15,12,18,9,7,4];

  const sportCtx = document.getElementById('sportChart');
  const sportChart = new Chart(sportCtx, {
    type: 'doughnut',
    data: { labels: sportLabels, datasets: [{ data: sportData, backgroundColor: sportColors, hoverOffset:12 }] },
    options: {
      plugins:{legend:{display:false}},
      onHover: (evt, items) => { evt.native.target.style.cursor = items && items.length ? 'pointer' : 'default'; },
      onClick: (evt, items) => {
        if(items.length && items[0].index === 0){
          // ç‚¹å‡»è·‘æ­¥ -> æ»šåŠ¨åˆ°å°åŠ©æ‰‹å¹¶å±•å¼€æ¸¸æˆå¡
          document.querySelector('aside').scrollIntoView({behavior:'smooth'});
          showGameCard();
        }
      }
    }
  });

  function updateLegend(){
    const wrapper = document.getElementById('legend'); wrapper.innerHTML='';
    const descs_cn = ['è·‘æ­¥/é©¬æ‹‰æ¾ï¼šå¤§ä¼—å‚ä¸åº¦é«˜ï¼Œé—¨æ§›ä½ã€å¥åº·/ç¤¾äº¤','è¶³çƒï¼šå—ä¼—å¹¿ï¼Œèµ›äº‹å¤š','æ£’çƒï¼šèŒä¸šè”èµ›çƒ­åº¦é«˜','å¥èº«ï¼šå¥èº«æˆ¿/è‡ªæˆ‘è®­ç»ƒ','ç¾½æ¯›çƒï¼šæ™®åŠä¸”ç¤¾äº¤æ€§å¼º','ç™»å±±ï¼šæˆ·å¤–ä¼‘é—²å¸¸è§','å…¶ä»–ï¼šå¤šç§è¿åŠ¨'];
    const descs_kr = ['ë‹¬ë¦¬ê¸°/ë§ˆë¼í†¤: ëŒ€ì¤‘ ì°¸ì—¬ë„ ë†’ìŒ, ì§„ì…ì¥ë²½ ë‚®ìŒ','ì¶•êµ¬: ëŒ€ì¤‘ì  ì¸ê¸°','ì•¼êµ¬: í”„ë¡œë¦¬ê·¸ ì¸ê¸°','í—¬ìŠ¤: ê°œì¸ìš´ë™(ì§)','ë°°ë“œë¯¼í„´: ë³´í¸ì  ë ˆì €ìš´ë™','ë“±ì‚°: ì•¼ì™¸ í™œë™ ì¸ê¸°','ê¸°íƒ€: ë‹¤ì–‘í•œ ì¢…ëª©'];
    let descs = lang==='kr' ? descs_kr : descs_cn;
    sportLabels.forEach((lab,i)=>{
      const row = document.createElement('div'); row.className='legend-item';
      const sw = document.createElement('span'); sw.className='swatch'; sw.style.background=sportColors[i];
      const txt = document.createElement('div'); txt.innerHTML = `<strong style="display:block">${(lang==='cn'? labCn(i) : lab)}</strong><div style="font-size:12px;color:var(--muted)">${descs[i]}</div>`;
      row.appendChild(sw); row.appendChild(txt); wrapper.appendChild(row);
    });
  }
  function labCn(i){ const a=['è·‘æ­¥ / é©¬æ‹‰æ¾','è¶³çƒ','æ£’çƒ','å¥èº«','ç¾½æ¯›çƒ','ç™»å±±','å…¶ä»–']; return a[i] || sportLabels[i]; }

  // Trend chart
  const trendCtx = document.getElementById('trendChart');
  const trendChart = new Chart(trendCtx, {
    type: 'line',
    data: { labels:['2019','2020','2021','2022','2023','2024'], datasets:[{ label:'Participants (10k)', data:[18,10,12,15,17,19], borderColor:'#1f6feb', backgroundColor:'rgba(31,111,235,0.07)', tension:0.25, fill:true }] },
    options:{ plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true } } }
  });

  // Analysis logic (unchanged)
  function analyzeInput(){
    const t = LANG[lang];
    const height = Number(document.getElementById('height').value);
    const weight = Number(document.getElementById('weight').value);
    const freq = document.getElementById('freq').value;
    const goal = Number(document.getElementById('goal').value);
    if(!height || !weight){ alert(t.alertHeight); return null; }
    const bmi = weight / ((height/100)*(height/100));
    let recommended = '5km';
    if(bmi >= 18.5 && bmi < 25){
      if(freq === '2') recommended = goal <= 10 ? '10km' : (goal === 21 ? (lang==='cn'?'åŠç¨‹é©¬æ‹‰æ¾': 'í•˜í”„ ë§ˆë¼í†¤') : '10km');
      if(freq === '3') recommended = (goal === 42) ? (lang==='cn'?'åŠç¨‹æˆ–å…¨ç¨‹':'í•˜í”„ ë˜ëŠ” í’€') : (goal===21 ? (lang==='cn'?'åŠç¨‹é©¬æ‹‰æ¾':'í•˜í”„ ë§ˆë¼í†¤') : '10km');
      if(freq === '1') recommended = '10km';
    } else if(bmi >= 25){
      recommended = freq === '3' ? '10km' : '5km';
    } else { recommended = '5km'; }
    let basePace = 8.0;
    if(freq === '1') basePace = 7.2;
    if(freq === '2') basePace = 6.5;
    if(freq === '3') basePace = 5.8;
    if(bmi < 18.5) basePace += 0.4;
    if(bmi >= 25) basePace += 0.3;
    const estMin = Math.round(goal * basePace);
    const hh = Math.floor(estMin/60);
    const mm = estMin % 60;
    const timeStr = hh>0 ? `${hh}${lang==='cn'?'å°æ—¶':'ì‹œê°„'} ${mm}${lang==='cn'?'åˆ†':'ë¶„'}` : `${mm}${lang==='cn'?'åˆ†':'ë¶„'}`;
    const advice = (goal===10) ? LANG[lang].advice10k : (goal===21 ? LANG[lang].adviceHalf : LANG[lang].adviceFull);
    return { bmi: bmi.toFixed(1), recommended, pace: basePace.toFixed(2), estTime: timeStr, advice };
  }

  document.getElementById('runAnalyze').addEventListener('click', ()=>{
    const t = LANG[lang]; const res = analyzeInput(); if(!res) return;
    const box = document.getElementById('resultBox'); let html = `<div style="font-weight:700;margin-bottom:8px">${t.resultTitle}</div>`;
    html += `<div class="stat-grid">`;
    html += `<div class="stat"><div class="stat-label">${t.bmiLabel}</div><div class="stat-value">${res.bmi}</div></div>`;
    html += `<div class="stat"><div class="stat-label">${t.recommendLabel}</div><div class="stat-value">${res.recommended}</div></div>`;
    html += `<div class="stat"><div class="stat-label">${t.paceLabel}</div><div class="stat-value">${res.pace} ${lang==='cn'?'åˆ†/å…¬é‡Œ':'ë¶„/km'}</div></div>`;
    html += `<div class="stat"><div class="stat-label">${t.timeLabel}</div><div class="stat-value">${res.estTime}</div></div>`;
    html += `</div>`;
    html += `<div class="advice"><div style="font-weight:700;margin-bottom:8px">${t.adviceTitle}</div><ul style="padding-left:18px;margin:0;color:var(--muted)">`;
    res.advice.forEach(a=> html += `<li>${a}</li>`); html += `</ul></div><div class="note">${t.noteText}</div>`;
    box.innerHTML = html; box.classList.add('show'); box.scrollIntoView({behavior:'smooth', block:'nearest'});
  });

  document.getElementById('quickEstimate').addEventListener('click', ()=>{
    const t = LANG[lang]; const height = Number(document.getElementById('height').value); const weight = Number(document.getElementById('weight').value); const freq = document.getElementById('freq').value;
    if(!height || !weight){ alert(t.alertHeight); return; }
    let basePace = 8.0; if(freq==='1') basePace=7.2; if(freq==='2') basePace=6.5; if(freq==='3') basePace=5.8;
    const bmi = weight / ((height/100)*(height/100)); if(bmi<18.5) basePace +=0.4; if(bmi>=25) basePace+=0.3;
    const distances = {'10km':10,'Half':21.0975,'Full':42.195};
    let html = `<div style="font-weight:700;margin-bottom:8px">${LANG[lang].quickTitle || 'Estimation'}</div>`;
    html += `<div style="margin-bottom:8px">${LANG[lang].quickSubtitle || ''} â€” ${basePace.toFixed(2)} ${lang==='cn'?'åˆ†/å…¬é‡Œ':'ë¶„/km'}</div>`;
    html += `<div class="stat-grid">`;
    for(const k in distances){ const minutes = Math.round(distances[k]*basePace); const hh=Math.floor(minutes/60); const mm=minutes%60; const timeStr = hh>0 ? `${hh}${lang==='cn'?'å°æ—¶':'ì‹œê°„'} ${mm}${lang==='cn'?'åˆ†':'ë¶„'}` : `${mm}${lang==='cn'?'åˆ†':'ë¶„'}`; html += `<div class="stat"><div class="stat-label">${k}</div><div class="stat-value">${timeStr}</div></div>`;}
    html += `</div><div class="note">${LANG[lang].noteText}</div>`; const box = document.getElementById('resultBox'); box.innerHTML = html; box.classList.add('show'); box.scrollIntoView({behavior:'smooth', block:'nearest'});
  });

  document.getElementById('clearBtn').addEventListener('click', ()=>{
    ['age','height','weight'].forEach(id=>document.getElementById(id).value='');
    document.getElementById('freq').value='low'; document.getElementById('goal').value='10';
    const box = document.getElementById('resultBox'); box.innerHTML=''; box.classList.remove('show');
  });

  // route mini runner
  const miniRunner = document.getElementById('miniRunner');
  document.getElementById('startRun').addEventListener('click', ()=>{
    const box = document.getElementById('routeBox'); const boxW = box.clientWidth; const target = boxW - 58;
    miniRunner.classList.add('running'); miniRunner.style.left='12px'; void miniRunner.offsetWidth; miniRunner.style.transition='left 3s linear'; miniRunner.style.left = target + 'px';
    setTimeout(()=>{ miniRunner.style.transition = 'left 0.9s ease'; miniRunner.style.left = '12px'; setTimeout(()=>{ miniRunner.classList.remove('running'); },1000); },3800);
  });

  // å±•ç¤º/éšè—æ¸¸æˆå¡
  const gameCard = document.getElementById('gameCard');
  const openGameBtn = document.getElementById('openGameBtn');
  function showGameCard(){ if(gameCard.style.display==='none'){ gameCard.style.display='block'; setTimeout(()=> { document.getElementById('gameCanvas').focus(); startGameLoopIfReady(); },150); } }
  openGameBtn.addEventListener('click', ()=>{ showGameCard(); document.getElementById('gameCanvas').scrollIntoView({behavior:'smooth'}); });

  /* ======================
     å°æ¸¸æˆè„šæœ¬ï¼ˆKEEP é£æ ¼è·‘æ­¥å°äººï¼‰
     å…³é”®ç‚¹ï¼šæŠŠæç®€çº¿æ¡ SVG æ¸²æŸ“ä¸º Imageï¼Œç„¶å drawImage åˆ° Canvasï¼ˆä¿è¯è·‘æ­¥å°äººä¸€å®šå¯è§ï¼‰
     ====================== */
  (function(){
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    // logical resolution
    canvas.width = 800; canvas.height = 360;
    let W = canvas.width, H = canvas.height;

    // player
    const player = { x: W*0.18, y: H*0.62, w: 48, h:48, vy:0, onGround:true, velX:0, baseSpeed:2.1, sprinting:false };

    // state
    let obstacles = [], pickups = [], trails = [], lastSpawn=0, tNow=0;
    let distanceMeters = 0, energy=100, difficulty='normal';
    let reached = {5:false,10:false,21:false};
    const hudDist = document.getElementById('hudDist');
    const hudPace = document.getElementById('hudPace');
    const hudEnergy = document.getElementById('hudEnergy');

    // controls
    const KEYS = { left:false, right:false, sprint:false };
    window.addEventListener('keydown', e=>{
      if(e.key==='ArrowLeft') KEYS.left=true;
      if(e.key==='ArrowRight') KEYS.right=true;
      if(e.key==='Shift') KEYS.sprint=true;
      if(e.code==='Space'){ if(player.onGround){ player.vy=-12; player.onGround=false; } }
    });
    window.addEventListener('keyup', e=>{
      if(e.key==='ArrowLeft') KEYS.left=false;
      if(e.key==='ArrowRight') KEYS.right=false;
      if(e.key==='Shift') KEYS.sprint=false;
    });

    // UI buttons (touch & mouse)
    const leftBtn = document.getElementById('leftBtn'), rightBtn = document.getElementById('rightBtn'), sprintBtn = document.getElementById('sprintBtn');
    ['touchstart','mousedown'].forEach(evt=> leftBtn.addEventListener(evt, ()=> KEYS.left=true) );
    ['touchend','mouseup','mouseleave'].forEach(evt=> leftBtn.addEventListener(evt, ()=> KEYS.left=false) );
    ['touchstart','mousedown'].forEach(evt=> rightBtn.addEventListener(evt, ()=> KEYS.right=true) );
    ['touchend','mouseup','mouseleave'].forEach(evt=> rightBtn.addEventListener(evt, ()=> KEYS.right=false) );
    ['touchstart','mousedown'].forEach(evt=> sprintBtn.addEventListener(evt, ()=> KEYS.sprint=true) );
    ['touchend','mouseup','mouseleave'].forEach(evt=> sprintBtn.addEventListener(evt, ()=> KEYS.sprint=false) );

    // spawn helpers
    function spawnObstacle(){ const size = 26 + Math.random()*42; obstacles.push({ x: W + 60 + Math.random()*120, y: H*0.65 + (player.h - size*0.6), w: size*0.6, h: size*0.6 }); }
    function spawnPickup(){ pickups.push({ x: W + 80 + Math.random()*200, y: H*0.65 - 48 - Math.random()*20, w:20, h:26}); }
    function addTrail(){ trails.push({ x: player.x + player.w*0.5 + Math.random()*6, y: player.y + player.h*0.55 + Math.random()*6, alpha: 1.0, life: 36 }); }

    function flash(color){ const overlay = document.createElement('div'); overlay.style.position='fixed'; overlay.style.left='0'; overlay.style.top='0'; overlay.style.width='100%'; overlay.style.height='100%'; overlay.style.background=color; overlay.style.opacity='0.06'; overlay.style.zIndex=9999; document.body.appendChild(overlay); setTimeout(()=> overlay.style.opacity='0', 60); setTimeout(()=> overlay.remove(),260); }

    function updateHUD(){ hudDist.innerText = (distanceMeters/1000).toFixed(2) + ' km'; hudEnergy.innerText = Math.max(0,Math.round(energy)) + '%'; const paceMin = Math.max(3.0, 6.5 - (player.baseSpeed/1.4)); const paceSec = Math.round((paceMin % 1)*60); hudPace.innerText = `${Math.floor(paceMin)}'${String(paceSec).padStart(2,'0')}" /km`; }

    function showMarker(msg){
      const rect = canvas.getBoundingClientRect();
      const overlay = document.createElement('div');
      overlay.style.position='absolute';
      overlay.style.left = (rect.left + rect.width*0.5) + 'px';
      overlay.style.top = (rect.top + 18) + 'px';
      overlay.style.transform='translateX(-50%)';
      overlay.style.padding='8px 14px';
      overlay.style.borderRadius='8px';
      overlay.style.background='linear-gradient(90deg, rgba(123,97,255,0.12), rgba(90,160,255,0.08))';
      overlay.style.color='#dffaff';
      overlay.style.fontWeight='800';
      overlay.style.zIndex=240;
      overlay.innerText = msg;
      document.body.appendChild(overlay);
      overlay.animate([{opacity:1, transform:'translateY(0)'},{opacity:0, transform:'translateY(-18px)'}], {duration:1400, easing:'ease-out'});
      setTimeout(()=>overlay.remove(),1500);
    }

    /* ====== KEEP é£æ ¼æç®€çº¿æ¡ SVG (å•è‰²) ======
       We'll create an inline SVG and render it as an Image to draw into canvas.
       The SVG is small, minimal stroke, looks like KEEP runner.
    */
    const runnerSVG = `
      <svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'>
        <g fill='none' stroke='#0f1724' stroke-width='4' stroke-linecap='round' stroke-linejoin='round'>
          <!-- head -->
          <circle cx='28' cy='20' r='8' fill='#0f1724'/>
          <!-- body -->
          <path d='M34 30 L46 44 L58 52' />
          <!-- arm -->
          <path d='M46 36 L60 28' />
          <!-- legs -->
          <path d='M46 58 L36 76' />
          <path d='M58 64 L74 78' />
          <!-- simple motion lines -->
          <path d='M20 48 C12 56, 10 70, 24 78' stroke-opacity='0.18' />
        </g>
      </svg>
    `;
    const runnerImg = new Image();
    let runnerImgReady = false;
    runnerImg.onload = ()=>{ runnerImgReady = true; startGameLoopIfReady(); };
    runnerImg.onerror = ()=>{ /* fallback - still draw silhouette if error */ runnerImgReady = false; startGameLoopIfReady(); };
    runnerImg.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(runnerSVG);

    function drawRunnerImg(ctx){
      if(runnerImgReady){
        // draw centered vertically to player's y
        const drawW = player.w;
        const drawH = player.h;
        const drawX = player.x; // left aligned
        const drawY = player.y - (player.h * 0.28); // adjust so head sits slightly above
        ctx.drawImage(runnerImg, drawX, drawY, drawW, drawH);
      } else {
        // fallback silhouette (if image fails)
        ctx.save(); ctx.fillStyle='#0f1724'; ctx.beginPath(); ctx.arc(player.x+player.w*0.5, player.y+14, 10,0,Math.PI*2); ctx.fill();
        ctx.fillRect(player.x+player.w*0.32, player.y+22, player.w*0.36, 28);
        ctx.fillRect(player.x+6, player.y+44, 10, 20);
        ctx.fillRect(player.x+player.w-16, player.y+44, 10, 20);
        ctx.restore();
      }
    }

    // main draw loop
    function draw(timestamp){
      if(!tNow) tNow=timestamp; const dt = Math.min(40, timestamp - tNow); tNow = timestamp;
      ctx.clearRect(0,0,W,H);

      // subtle background lines
      ctx.save(); ctx.globalAlpha = 0.14; ctx.strokeStyle = 'rgba(90,160,255,0.05)'; ctx.lineWidth=2;
      for(let i=0;i<2;i++){
        ctx.beginPath();
        for(let x=0;x<=W;x+=12){
          const y = 80 + Math.sin((timestamp/700)*(0.6+i*0.25) + x/120)* (14 + i*6);
          if(x===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
        }
        ctx.stroke();
      }
      ctx.restore();

      // ground strip
      ctx.fillStyle='rgba(0,0,0,0.18)'; ctx.fillRect(0,H*0.72,W,H*0.28);

      // movement
      if(KEYS.left) player.velX = -3.6;
      else if(KEYS.right) player.velX = 3.6;
      else player.velX *= 0.86;

      player.sprinting = KEYS.sprint && energy>6;
      const sprintFactor = player.sprinting ? 1.9 : 1.0;
      if(player.sprinting) energy -= 12 * (dt/1000); else energy += 6 * (dt/1000);
      energy = Math.min(100, Math.max(0, energy));

      player.x += player.velX * (player.baseSpeed * sprintFactor);
      const leftLimit=24, rightLimit = W - player.w - 24;
      if(player.x<leftLimit) player.x=leftLimit;
      if(player.x>rightLimit) player.x=rightLimit;

      // gravity
      player.vy += 0.8; player.y += player.vy; if(player.y > H*0.65){ player.y=H*0.65; player.vy=0; player.onGround=true; }

      // trails
      if(Math.random() < 0.28) addTrail();

      // draw trails
      for(let i=trails.length-1;i>=0;i--){
        const tr = trails[i];
        ctx.save(); ctx.fillStyle = 'rgba(0,212,255,'+(tr.alpha*0.06)+')'; ctx.beginPath(); ctx.ellipse(tr.x,tr.y,26,8,0,0,Math.PI*2); ctx.fill(); ctx.restore();
        tr.alpha -= 0.02; tr.life -= 1; tr.x -= 1.2;
        if(tr.life<=0 || tr.alpha<=0) trails.splice(i,1);
      }

      // obstacles
      const worldSpeed = (1.8 + (difficulty==='hard'?0.9:0.0)) * (1 + (distanceMeters/10000));
      for(let i=obstacles.length-1;i>=0;i--){
        const o = obstacles[i];
        o.x -= (worldSpeed * 2.0);
        ctx.save(); ctx.fillStyle='#242424'; ctx.shadowColor='rgba(0,0,0,0.5)'; ctx.shadowBlur=6;
        ctx.fillRect(o.x,o.y,o.w,o.h);
        ctx.restore();
        if(player.x < o.x + o.w && player.x + player.w > o.x && player.y + player.h > o.y && player.y < o.y + o.h){
          energy -= 18; player.x -= 28; flash('#ff5a5f'); obstacles.splice(i,1);
        }
        if(o.x < -120) obstacles.splice(i,1);
      }

      // pickups
      for(let i=pickups.length-1;i>=0;i--){
        const p = pickups[i]; p.x -= (worldSpeed * 2.2);
        ctx.save(); ctx.fillStyle='rgba(0,212,255,0.95)'; ctx.fillRect(p.x,p.y,p.w,p.h); ctx.restore();
        if(player.x < p.x + p.w && player.x + player.w > p.x && player.y + player.h > p.y && player.y < p.y + p.h){
          energy = Math.min(100, energy + 28); for(let k=0;k<6;k++) addTrail(); pickups.splice(i,1); continue;
        }
        if(p.x < -120) pickups.splice(i,1);
      }

      // draw runner image (KEEP-style)
      drawRunnerImg(ctx);

      // spawn occasionally
      if(timestamp - lastSpawn > (900 - Math.min(500, distanceMeters/6))){
        lastSpawn = timestamp;
        for(let k=0;k < (0.7 + Math.random()*1.6); k++){
          if(Math.random() < 0.7) spawnObstacle(); else spawnPickup();
        }
      }

      // distance progression (approx)
      const forwardMeters = (1.6 * sprintFactor * (difficulty==='hard'?1.2:1.0)) * (dt / 16);
      distanceMeters += forwardMeters;

      // markers
      [5,10,21].forEach(km => {
        if(!reached[km] && (distanceMeters/1000) >= km - 0.02){ reached[km]=true; showMarker(km + ' km'); }
      });

      updateHUD();

      // ground indicator
      ctx.fillStyle='rgba(255,255,255,0.02)'; ctx.fillRect(0,H*0.72,W,2);

      if((distanceMeters/1000) >= 42){
        setTimeout(()=>{ alert('Finish! ' + (distanceMeters/1000).toFixed(2) + ' km'); location.reload(); }, 100);
        return;
      }

      requestAnimationFrame(draw);
    }

    // ensure loop only starts when runner image ready & game visible
    let loopStarted=false, imageReadyFlag=false;
    function startGameLoopIfReady(){
      // mark image readiness
      imageReadyFlag = true;
      if(!loopStarted && gameCard.style.display !== 'none'){
        loopStarted = true;
        requestAnimationFrame(draw);
      }
    }

    // if runner image loaded earlier it triggers onload -> startGameLoopIfReady
    runnerImg.onload = ()=> startGameLoopIfReady();
    runnerImg.onerror = ()=> startGameLoopIfReady();

    // observe show/hide
    const observer = new MutationObserver(()=>{ if(document.getElementById('gameCard').style.display !== 'none'){ if(!loopStarted) { loopStarted=true; requestAnimationFrame(draw); } }});
    observer.observe(document.getElementById('gameCard'), { attributes:true, attributeFilter:['style'] });

    // initial spawn
    setInterval(()=>{ if(document.getElementById('gameCard').style.display !== 'none'){ if(Math.random() < 0.8) spawnObstacle(); else spawnPickup(); } }, 1200);

    // prevent spacebar scrolling
    window.addEventListener('keydown', function(e){ if(e.code==='Space' && e.target===document.body) e.preventDefault(); });

    // expose some functions for debugging (optional)
    window._miniGame = { player, obstacles, pickups, distanceMeters };

  })();

  // ensure charts resize on window resize
  window.addEventListener('resize', ()=>{ sportChart.resize(); trendChart.resize(); });

  </script>
</body>
</html>
